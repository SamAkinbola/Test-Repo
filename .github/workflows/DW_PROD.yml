name: DW_PROD_TEST1

on:
  pull_request:
    types: [closed]    # Runs when PR is closed (includes merged)
  workflow_dispatch:   # Allow manual trigger

jobs:
  build:
    if: >
      github.event.pull_request.merged == true &&
      contains(join(fromJson(toJson(github.event.pull_request.labels)).*.name, ','), 'DW_PROD_TEST')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install SnowSQL
        env:
          SNOWSQL_PRIVATE_KEY_PASSPHRASE: "${{ secrets.DW_PROD_TEST_PASSPHRASE }}"
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.3/linux_x86_64/snowsql-1.3.2-linux_x86_64.bash
          SNOWSQL_DEST=~/bin SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.3.2-linux_x86_64.bash

      - name: Prepare user private key
        run: |
          printf '%s\n' "${{ secrets.DW_PROD_TEST_PRIVATE_KEY }}" > ./private_key.pem

      - name: Identify changed SQL files
        id: changed_files
        run: |
          echo "Identifying changed SQL files..."
          SQL_DIR="."
          CHANGED_FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD "$SQL_DIR" | grep -i '\.sql$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No new or modified SQL files found. Skipping deployment."
            exit 0
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy changed SQL files to Snowflake
        if: steps.changed_files.outputs.changed_files != ''
        run: |
          echo "Deploying changed SQL files..."
          CHANGED_FILES="${{ steps.changed_files.outputs.changed_files }}"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No SQL files to deploy."
            exit 0
          fi

          echo "$CHANGED_FILES" | while read file; do
            if [ -f "$file" ]; then
              echo "Executing $file..."
              ~/bin/snowsql \
                -a ${{ secrets.DW_PROD_TEST_ACCOUNT }} \
                -u ${{ secrets.DW_PROD_TEST_SVC_ACCOUNT }} \
                --private-key-path ./private_key.pem \
                -f "$file" \
                -d ${{ secrets.DW_PROD_TEST_DB }} \
                -r ${{ secrets.DW_PROD_TEST_ROLE }} \
                -w ${{ secrets.DW_PROD_TEST_WH }} || { echo "Failed executing $file"; exit 1; }
            else
              echo "File $file does not exist. Skipping."
            fi
          done
