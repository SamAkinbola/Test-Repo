name: Deploy SSRS Reports

on:
  push:
    branches:
      - prod
  workflow_dispatch:
    inputs:
      report_name:
        description: 'Name of the report to deploy'
        required: false

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy SSRS Reports
        run: |
          # Install ReportingServicesTools module if not already available
          if (-not (Get-Module -ListAvailable -Name ReportingServicesTools)) {
            Install-Module -Name ReportingServicesTools -Scope CurrentUser -Force
          }

          # Import module into the current session
          Import-Module ReportingServicesTools

          # Define paths and inputs
          $sourceFolder = "${{ github.workspace }}\RDL"
          $targetReportServerUri = "http://your-ssrs-server/ReportServer"
          $targetFolder = "/TrackerReports"
          $reportName = "${{ github.event.inputs.report_name }}"

          # Validate source folder
          if (-not (Test-Path $sourceFolder)) {
            Write-Error "Source folder not found: $sourceFolder"
            exit 1
          }

          # Deploy single report if specified
          if (-not [string]::IsNullOrEmpty($reportName)) {
            $reportPath = Join-Path $sourceFolder "$reportName.rdl"
            if (-not (Test-Path $reportPath)) {
              Write-Error "Specified report not found: $reportPath"
              exit 1
            }
            Write-Output "Deploying report: $reportPath"
            Write-RsCatalogItem -Path $reportPath -ReportServerUri $targetReportServerUri -Destination "$targetFolder/$reportName" -OverWrite
          }
          else {
            # Deploy all RDL files in source folder
            Get-ChildItem -Path $sourceFolder -Filter *.rdl | ForEach-Object {
              $destinationPath = "$targetFolder/$($_.BaseName)"
              Write-Output "Deploying report: $($_.FullName) to $destinationPath"
              Write-RsCatalogItem -Path $_.FullName -ReportServerUri $targetReportServerUri -Destination $destinationPath -OverWrite
            }
          }
        shell: pwsh
        env:
          SSRS_USERNAME: ${{ secrets.SSRS_USERNAME }}
          SSRS_PASSWORD: ${{ secrets.SSRS_PASSWORD }}
